# Railway configuration for monorepo

# Frontend service
[frontend]
name = "paxform-frontend"
root = "frontend"

[frontend.build]
builder = "nixpacks"

[frontend.build.nixpacks]
  [frontend.build.nixpacks.phases.setup]
  nixPkgs = ["nodejs_20"]

  [frontend.build.nixpacks.phases.install]
  cmds = ["npm install"]

  [frontend.build.nixpacks.phases.build]
  cmds = ["npm run build"]

[frontend.deploy]
startCommand = "/usr/sbin/nginx -g 'daemon off;'"
healthcheckPath = "/health"
healthcheckTimeout = 30

# Backend service
[backend]
name = "paxform-backend"
root = "backend"

[backend.build]
builder = "nixpacks"

[backend.build.nixpacks]
  [backend.build.nixpacks.phases.setup]
  nixPkgs = ["php82", "php82Extensions.composer"]

  [backend.build.nixpacks.phases.install]
  cmds = ["composer install --no-dev --optimize-autoloader"]

  [backend.build.nixpacks.phases.build]
  cmds = ["php artisan config:cache", "php artisan route:cache", "php artisan view:cache"]

[backend.deploy]
startCommand = "php-fpm"
healthcheckPath = "/api/health"
healthcheckTimeout = 30

# Environment variables
[environments]
  [environments.production]
    NODE_ENV = "production"
    VITE_API_URL = "https://paxform-assessment-url.railway.app"
    PORT = 80
    
    # Database configuration
    DB_CONNECTION = "mysql"
    DB_HOST = "${RAILWAY_MYSQLHOST}"
    DB_PORT = "${RAILWAY_MYSQLPORT}"
    DB_DATABASE = "${RAILWAY_MYSQLDATABASE}"
    DB_USERNAME = "${RAILWAY_MYSQLUSER}"
    DB_PASSWORD = "${RAILWAY_MYSQLPASSWORD}"
